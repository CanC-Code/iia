name: Android Build & Icon Gen

on:
  workflow_dispatch: # Manual trigger as requested
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive' # Vital for stable-diffusion.cpp

    - name: set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Install ImageMagick
      run: sudo apt-get install -y imagemagick

    - name: Generate Adaptive Icons
      run: |
        # Generate the base icon from a central SVG or PNG
        # This creates the 512x512 master icon for the Moto G Play
        mkdir -p app/src/main/res/mipmap-xxxhdpi
        convert -size 512x512 canvas:none \
                -fill "#6200EE" -draw "circle 256,256 256,10" \
                -fill white -pointsize 200 -gravity center -draw "text 0,0 'IIA'" \
                app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
        
        # In a real scenario, you'd use 'mogrify' to resize for all densities
        echo "Icons generated via ImageMagick"

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle
      run: ./gradlew assembleDebug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: iia-debug-apk
        path: app/build/outputs/apk/debug/app-debug.apk
